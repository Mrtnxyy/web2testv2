{
  "name": "opera-archivum",
  "version": "1.0.0",
  "main": "indito.js",
  "scripts": {
    "start": "node indito.js",
    "seed": "node seed_db.js",
    "admin": "node create_admin.js"
  },
  "dependencies": {
    "bcrypt": "^5.1.0",
    "body-parser": "^1.20.2",
    "dotenv": "^16.0.3",
    "ejs": "^3.1.9",
    "express": "^4.18.2",
    "express-ejs-layouts": "^2.5.1",
    "express-session": "^1.17.3",
    "method-override": "^3.0.0",
    "mongoose": "^8.0.0"  <-- MySQL2 helyett Mongoose
  }
}


### `indito.js:{F≈ë Server √©s MongoDB Csatlakoz√°s}:indito.js`
```javascript
// indito.js

// Modulok import√°l√°sa
const express = require('express');
const expressLayouts = require('express-ejs-layouts');
const app = express();
const dotenv = require('dotenv').config(); 
const session = require('express-session');
const mongoose = require('mongoose'); // <-- Mongoose a MongoDB-hez
const path = require('path');
const methodOverride = require('method-override');

// √ötvonal f√°jlok import√°l√°sa
const indexRouter = require('./routes/index'); 
const authRouter = require('./routes/auth');
const crudRouter = require('./routes/crud');
const messagesRouter = require('./routes/messages');

const PORT = process.env.PORT || 10000;

// ADATB√ÅZIS CSATLAKOZ√ÅS (MongoDB Atlas)
// A MONGO_URI-t kell be√°ll√≠tani a Renderen!
mongoose.connect(process.env.MONGO_URI, { useNewUrlParser: true, useUnifiedTopology: true })
    .then(() => console.log('MongoDB Csatlakoz√°s sikeres!'))
    .catch(err => console.error('MongoDB Csatlakoz√°si hiba:', err));

// K√ñZTES SZOFTVER (MIDDLEWARE) BE√ÅLL√çT√ÅSOK
app.use(express.static(path.join(__dirname, 'public')));
app.use(methodOverride('_method')); // App.js-b≈ël √°thozva

// Session be√°ll√≠t√°sok
app.use(session({
    secret: process.env.SESSION_SECRET || 'valami_titkos',
    resave: false,
    saveUninitialized: true,
}));

// Body-parser a POST adatok feldolgoz√°s√°hoz
app.use(express.urlencoded({ extended: true }));


// user v√°ltoz√≥ be√°ll√≠t√°sa a n√©zetekhez (res.locals)
app.use((req, res, next) => {
    res.locals.user = req.session.user || null; 
    next();
});


// Express Layouts be√°ll√≠t√°sa
app.use(expressLayouts);

// EJS be√°ll√≠t√°sa mint n√©zetmotor
app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));
app.set('layout', 'layout'); 


// √öTVONALAK (ROUTES) BE√ÅLL√çT√ÅSA
app.use('/', indexRouter);
app.use('/auth', authRouter);
app.use('/crud', crudRouter);
app.use('/messages', messagesRouter);


// SZERVER IND√çT√ÅSA
app.listen(PORT, () => {
    console.log(`Alkalmaz√°s fut: http://localhost:${PORT} (port ${PORT})`);
});


### 3. `config/db.js` (Elt√°vol√≠tva)

A r√©gi **`config/db.js`** f√°jlban l√©v≈ë MySQL kapcsolatk√©sz√≠t≈ë k√≥d m√°r **felesleges** √©s hib√°t okoz. Ezt a f√°jlt **t√∂r√∂ln√∂d kell**, vagy a tartalm√°t √ºresre kell cser√©lned.

---

## 2. üß± Mongoose Modellek (`models/` mappa)

Hozd l√©tre a `models` mapp√°t, √©s m√°sold be a k√∂vetkez≈ë 5 f√°jlt. Ezek a modellek teszik lehet≈ëv√©, hogy a Node.js-en kereszt√ºl kezelj√ºk a MongoDB-t.

### `models/User.js`

```javascript
// models/User.js
const mongoose = require('mongoose');

const userSchema = new mongoose.Schema({
    // Az 'id' mez≈ë a MongoDB-ben automatikusan l√©trej√∂n (_id)
    name: { type: String, required: true },
    email: { type: String, required: true, unique: true },
    password: { type: String, required: true },
    role: { type: String, default: 'user' },
    created_at: { type: Date, default: Date.now }
});

module.exports = mongoose.model('User', userSchema, 'users');


### `models/Enekes.js`

```javascript
// models/Enekes.js
const mongoose = require('mongoose');

const enekesSchema = new mongoose.Schema({
    // Az eredeti ID-t megtartjuk a seedel√©shez √©s a kapcsolatokhoz
    originalId: { type: Number, required: true, unique: true }, 
    nev: { type: String, required: true },
    szulev: { type: Number },
    created_at: { type: Date, default: Date.now }
});

module.exports = mongoose.model('Enekes', enekesSchema, 'enekesek');


### `models/Mu.js`

```javascript
// models/Mu.js
const mongoose = require('mongoose');

const muSchema = new mongoose.Schema({
    originalId: { type: Number, required: true, unique: true },
    szerzo: { type: String, required: true },
    cim: { type: String, required: true }
});

module.exports = mongoose.model('Mu', muSchema, 'muvek');


### `models/Szerep.js`

```javascript
// models/Szerep.js
const mongoose = require('mongoose');

const szerepSchema = new mongoose.Schema({
    originalId: { type: Number, required: true, unique: true },
    szerepnev: { type: String, required: true },
    // Kapcsolat a Mu modellel az originalId-n kereszt√ºl
    muid: { type: Number, required: true }, 
    hang: { type: String }
});

module.exports = mongoose.model('Szerep', szerepSchema, 'szerepek');


### `models/Repertoar.js`

```javascript
// models/Repertoar.js
const mongoose = require('mongoose');

const repertoarSchema = new mongoose.Schema({
    // Kapcsolatok az originalId-k alapj√°n
    enekesid: { type: Number, required: true }, 
    szerepid: { type: Number, required: true },
    utoljara: { type: Number },
});

module.exports = mongoose.model('Repertoar', repertoarSchema, 'repertoar');


---

## 3. üíæ Logika √©s Szkriptek

### `create_admin.js` (Admin L√©trehoz√°s)

√Åt√≠rva Mongoose-ra. Ez a szkript l√©trehoz egy admin felhaszn√°l√≥t a `users` gy≈±jtem√©nyben.

```javascript
// create_admin.js
const bcrypt = require('bcrypt');
const mongoose = require('mongoose');
require('dotenv').config();

// Modellek import√°l√°sa
const User = require('./models/User');

(async () => {
  if (!process.env.MONGO_URI) {
      console.error('MONGO_URI k√∂rnyezeti v√°ltoz√≥ hi√°nyzik!');
      process.exit(1);
  }

  await mongoose.connect(process.env.MONGO_URI);
  
  try {
    const name = 'Admin';
    const email = process.argv[2] || 'admin@pelda.hu';
    const password = process.argv[3] || 'admin123';
    
    const existingUser = await User.findOne({ email });
    if (existingUser) {
        console.log(`Admin user m√°r l√©tezik ezzel az email c√≠mmel: ${email}`);
        process.exit(0);
    }

    const hash = await bcrypt.hash(password, 10);
    
    // Mongoose: √∫j felhaszn√°l√≥ l√©trehoz√°sa
    await User.create({
        name: name,
        email: email,
        password: hash,
        role: 'admin'
    });
    
    console.log('Admin user l√©trehozva:', email, 'Jelsz√≥:', password);
    process.exit(0);

  } catch (err) {
    console.error('Hiba az admin user l√©trehoz√°sakor:', err);
    process.exit(1);
  } finally {
    mongoose.connection.close();
  }
})();


### `seed_db.js` (Adatfelt√∂lt≈ë Script)

Ez a szkript felt√∂lti az √∂sszes TXT f√°jl tartalm√°t a MongoDB gy≈±jtem√©nyekbe.

```javascript
// seed_db.js
const fs = require('fs');
const path = require('path');
const mongoose = require('mongoose');
require('dotenv').config();

// Modellek import√°l√°sa
const Enekes = require('./models/Enekes');
const Mu = require('./models/Mu');
const Szerep = require('./models/Szerep');
const Repertoar = require('./models/Repertoar');

const dataFiles = [
    { file: 'enekes.txt', model: Enekes, fields: ['id', 'nev', 'szulev'] },
    { file: 'mu.txt', model: Mu, fields: ['id', 'szerzo', 'cim'] },
    { file: 'szerep.txt', model: Szerep, fields: ['id', 'szerepnev', 'muid', 'hang'] },
    { file: 'repertoar.txt', model: Repertoar, fields: ['enekesid', 'szerepid', 'utoljara'] }
];

async function parseFile(filePath, fields) {
    const fileContent = fs.readFileSync(filePath, 'utf8');
    const lines = fileContent.trim().split('\n').slice(1); // Fejl√©c kihagy√°sa
    
    return lines.map(line => {
        const values = line.split(';').map(v => v.trim());
        const doc = {};
        fields.forEach((field, i) => {
            let value = values[i];
            if (field === 'id' || field === 'muid' || field === 'enekesid' || field === 'szerepid' || field === 'szulev' || field === 'utoljara') {
                doc[field === 'id' ? 'originalId' : field] = parseInt(value) || 0;
            } else {
                doc[field] = value;
            }
        });
        return doc;
    });
}

async function seedDatabase() {
    if (!process.env.MONGO_URI) {
        console.error('MONGO_URI k√∂rnyezeti v√°ltoz√≥ hi√°nyzik!');
        return;
    }
    
    await mongoose.connect(process.env.MONGO_URI);
    console.log('MongoDB Csatlakoz√°s sikeres, kezd≈ëdik a felt√∂lt√©s...');
    
    try {
        for (const data of dataFiles) {
            const filePath = path.join(__dirname, 'data', data.file);
            
            // Adatok bet√∂lt√©se TXT-b≈ël
            const documents = await parseFile(filePath, data.fields);
            
            // Gy≈±jtem√©ny t√∂rl√©se az ism√©telt futtat√°s elker√ºl√©se v√©gett
            await data.model.deleteMany({}); 
            
            // Adatok besz√∫r√°sa
            const result = await data.model.insertMany(documents);
            
            console.log(`[Sikeres]: ${data.model.collection.collectionName} - ${result.length} dokumentum besz√∫rva.`);
        }

    } catch (error) {
        console.error('Kritikus hiba a felt√∂lt√©s sor√°n:', error.message);
        console.error(error.stack);
    } finally {
        mongoose.connection.close();
    }
}

seedDatabase();


---

## 4. üñºÔ∏è √ötvonalak (Mongoose Lek√©rdez√©sek)

Az √∫tvonalak √°t√≠rva Mongoose-ra a `mysql2` helyett.

### `routes/crud.js`

```javascript
// routes/crud.js
const express = require('express');
const router = express.Router();
const Enekes = require('../models/Enekes'); // <-- Mongoose modell
const Mu = require('../models/Mu'); 
const Szerep = require('../models/Szerep'); 
const Repertoar = require('../models/Repertoar'); 
const mongoose = require('mongoose');

// Middleware: admin jogosults√°g ellen≈ërz√©se (felt√©telezve, hogy a User modellen van role mez≈ë)
function ensureAdmin(req, res, next) {
    if (req.session.user && req.session.user.role === 'admin') {
        return next();
    }
    res.status(403).send('Hozz√°f√©r√©s megtagadva.');
}

// √ânekesek list√°z√°sa (CRUD f≈ëoldal)
router.get('/', async (req, res) => {
    try {
        const enekesek = await Enekes.find().sort({ nev: 1 }).lean(); 
        res.render('crud/enekes_list', { 
            title: '√ânekesek (CRUD)', 
            enekesek: enekesek,
            messages: req.session.messages // felt√©telezve, hogy messages-t haszn√°l a flash √ºzenetekhez
        });
        req.session.messages = [];
    } catch (error) {
        console.error('Hiba az √©nekesek lek√©rdez√©sekor:', error);
        res.render('error', { message: 'Adatb√°zis hiba t√∂rt√©nt a lek√©rdez√©skor.' });
    }
});

// √ânekes szerkeszt√©se ≈±rlap
router.get('/edit/:id', ensureAdmin, async (req, res) => {
    try {
        // A Mongoose ID (_id) haszn√°lata
        const enekes = await Enekes.findById(req.params.id).lean(); 
        if (!enekes) {
            return res.status(404).send('√ânekes nem tal√°lhat√≥');
        }
        res.render('crud/edit_enekes', { title: '√ânekes szerkeszt√©se', enekes: enekes });
    } catch (error) {
        console.error('Hiba a szerkeszt≈ë ≈±rlap bet√∂lt√©sekor:', error);
        res.status(500).send('Hiba a szerkeszt≈ë ≈±rlap bet√∂lt√©sekor.');
    }
});

// √ânekes friss√≠t√©se
router.post('/edit/:id', ensureAdmin, async (req, res) => {
    const { nev, szulev } = req.body;
    try {
        await Enekes.findByIdAndUpdate(req.params.id, { nev, szulev: parseInt(szulev) });
        req.session.messages = ['√ânekes sikeresen friss√≠tve!'];
        res.redirect('/crud');
    } catch (error) {
        console.error('Hiba az √©nekes friss√≠t√©sekor:', error);
        res.render('crud/edit_enekes', { 
            title: '√ânekes szerkeszt√©se', 
            enekes: { _id: req.params.id, nev, szulev },
            error: 'Hiba t√∂rt√©nt a friss√≠t√©s sor√°n.'
        });
    }
});

// √ânekes t√∂rl√©se
router.post('/delete/:id', ensureAdmin, async (req, res) => {
    try {
        await Enekes.findByIdAndDelete(req.params.id);
        
        // Elt√°vol√≠t√°s a reperto√°rb√≥l az eredeti ID alapj√°n (felt√©telezve, hogy a Mongoose ID-t haszn√°ljuk a t√∂rl√©shez)
        // Mivel a reperto√°rban originalId van, ez bonyolultabb. Egyszer≈±s√≠t√©sk√©nt: 
        // A Mongoose ID-t haszn√°lva:
        
        // Ez a sor t√∂rli a dokumentumot a reperto√°r gy≈±jtem√©nyb≈ël is (mivel itt az originalId-k vannak):
        const deletedEnekes = await Enekes.findById(req.params.id).select('originalId');
        if(deletedEnekes) {
            await Repertoar.deleteMany({ enekesid: deletedEnekes.originalId });
        }
        
        req.session.messages = ['√ânekes sikeresen t√∂r√∂lve!'];
        res.redirect('/crud');
    } catch (error) {
        console.error('Hiba az √©nekes t√∂rl√©sekor:', error);
        req.session.messages = ['Hiba t√∂rt√©nt a t√∂rl√©s sor√°n.'];
        res.redirect('/crud');
    }
});

module.exports = router;


### `routes/auth.js`

```javascript
// routes/auth.js
const express = require('express');
const router = express.Router();
const bcrypt = require('bcrypt');
const User = require('../models/User'); // <-- Mongoose User modell import√°l√°sa

// Regisztr√°ci√≥s ≈±rlap megjelen√≠t√©se
router.get('/register', (req, res) => {
    res.render('auth/register', { error: null });
});

// Regisztr√°ci√≥ kezel√©se
router.post('/register', async (req, res) => {
    const { name, email, password } = req.body;
    
    try {
        // Mongoose: keres√©s
        const existingUser = await User.findOne({ email: email });

        if (existingUser) {
            return res.render('auth/register', { error: 'Ez az e-mail c√≠m m√°r regisztr√°lva van.' });
        }
        
        const hashedPassword = await bcrypt.hash(password, 10);
        
        // Mongoose: √∫j felhaszn√°l√≥ l√©trehoz√°sa
        await User.create({
            name: name,
            email: email,
            password: hashedPassword
        });
        
        res.redirect('/auth/login');

    } catch (error) {
        console.error('Regisztr√°ci√≥s hiba:', error);
        res.render('auth/register', { error: 'Hiba t√∂rt√©nt a regisztr√°ci√≥ sor√°n.' });
    }
});

// Bejelentkez√©si ≈±rlap megjelen√≠t√©se
router.get('/login', (req, res) => {
    res.render('auth/login', { error: null });
});

// Bejelentkez√©s kezel√©se
router.post('/login', async (req, res) => {
    const { email, password } = req.body;

    try {
        // Mongoose: felhaszn√°l√≥ keres√©se
        const user = await User.findOne({ email: email });

        if (!user) {
            return res.render('auth/login', { error: 'Hib√°s e-mail c√≠m vagy jelsz√≥.' });
        }

        const passwordMatch = await bcrypt.compare(password, user.password);

        if (passwordMatch) {
            // MongoDB-ben az ID az _id mez≈ë
            req.session.user = { id: user._id, name: user.name, role: user.role };
            res.redirect('/');
        } else {
            res.render('auth/login', { error: 'Hib√°s e-mail c√≠m vagy jelsz√≥.' });
        }

    } catch (error) {
        console.error('Bejelentkez√©si hiba:', error);
        res.render('auth/login', { error: 'Hiba t√∂rt√©nt a bejelentkez√©s sor√°n.' });
    }
});

// Kijelentkez√©s
router.get('/logout', (req, res) => {
    req.session.destroy(err => {
        if (err) {
            return console.error('Hiba a kijelentkez√©skor:', err);
        }
        res.redirect('/');
    });
});

module.exports = router;


---

**A teend≈ëd a k√∂vetkez≈ë:**

1.  **F√ºgg≈ës√©gek Friss√≠t√©se:** Cser√©ld le a `package.json` tartalm√°t a fentire, √©s futtasd az `npm install mongoose` parancsot a helyi g√©peden.
2.  **Modellek L√©trehoz√°sa:** Hozd l√©tre a `models/` mapp√°t, √©s m√°sold bele az 5 Mongoose modellt.
3.  **K√≥d Cser√©je:** Cser√©ld ki az **`indito.js`**, **`create_admin.js`**, **`routes/crud.js`**, **`routes/auth.js`** f√°jlok tartalm√°t a fentiekre.
4.  **Felt√∂lt≈ë Szkript:** Hozd l√©tre a **`seed_db.js`** f√°jlt a gy√∂k√©rben, √©s m√°sold bele a szkriptet.
5.  **Git Push:** T√∂ltsd fel a teljes, m√≥dos√≠tott k√≥dot a Git rep√≥dra.
6.  **Adatb√°zis Felt√∂lt√©se:** Futtasd a **`node seed_db.js`** parancsot a Renderen egy Job-on vagy Cron Job-on kereszt√ºl a felt√∂lt√©shez.
