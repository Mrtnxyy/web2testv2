<div class="crud-container">
    <h1 class="page-title">Adminisztr치ci칩s Fel칲let</h1>

    <div class="admin-grid">
        
        <div class="admin-box">
            <h2 class="box-title">Admin Felhaszn치l칩k</h2>
            <div class="admin-list">
                <% if (admins.length > 0) { %>
                    <% admins.forEach(admin => { %>
                        <div class="admin-item">
                            <div class="admin-icon">游녬</div>
                            <div class="admin-details">
                                <strong><%= admin.name %></strong>
                                <small><%= admin.email %></small>
                            </div>
                        </div>
                    <% }) %>
                <% } else { %>
                    <p style="text-align:center; color:#888;">Nincs admin felhaszn치l칩.</p>
                <% } %>
            </div>
        </div>

        <div class="admin-box wide-box">
            <h2 class="box-title">칐sszes Regisztr치lt Felhaszn치l칩</h2>
            
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>N칠v / Email</th>
                        <th>Regisztr치ci칩</th>
                        <th>Jelenlegi Jog</th>
                        <th style="text-align: center;">Admin Jog</th>
                    </tr>
                </thead>
                <tbody>
                    <% allUsers.forEach(u => { %>
                        <tr>
                            <td>
                                <div style="font-weight: bold; color: #fff;"><%= u.name %></div>
                                <div style="font-size: 0.85rem; color: #888;"><%= u.email %></div>
                            </td>
                            <td>
                                <%= u.created_at ? new Date(u.created_at).toLocaleDateString() : '-' %>
                            </td>
                            
                            <td id="role-text-<%= u._id %>" class="<%= u.role === 'admin' ? 'role-admin' : 'role-user' %>">
                                <%= u.role %>
                            </td>

                            <td style="text-align: center;">
                                <% const isMe = u.email === currentUser.email; %>

                                <label class="switch">
                                    <input type="checkbox" 
                                           onchange="toggleRole('<%= u._id %>', this)" 
                                           <%= u.role === 'admin' ? 'checked' : '' %>
                                           <%= isMe ? 'disabled' : '' %>>
                                    <span class="slider round"></span>
                                </label>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>

    </div>
    
    <div style="margin-top: 30px; text-align: center;">
        <a href="/" class="btn-cancel">Vissza a f콈oldalra</a>
    </div>
</div>

<script>
    async function toggleRole(userId, checkbox) {
        const newRole = checkbox.checked ? 'admin' : 'user';
        const roleText = document.getElementById('role-text-' + userId);

        console.log("K칖LD칄S:", userId, newRole);

        try {
            const response = await fetch('/admin/toggle-role', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, newRole })
            });

            const result = await response.json();

            if (result.success) {
                roleText.innerText = newRole;
                
                if (newRole === 'admin') {
                    roleText.className = 'role-admin';
                } else {
                    roleText.className = 'role-user';
                }
            } else {
                alert('Hiba t칬rt칠nt: ' + (result.error || 'Ismeretlen hiba'));
                checkbox.checked = !checkbox.checked;
            }
        } catch (error) {
            console.error('Error:', error);
            alert('H치l칩zati hiba!');
            checkbox.checked = !checkbox.checked;
        }
    }
</script>