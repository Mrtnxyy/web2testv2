<div class="crud-container">

    <h1 class="page-title">Énekesek Archívuma (<%= enekesek.length %> bejegyzés)</h1>

    <% if (messages && messages.length > 0) { %>
        <div id="toast-box" class="toast-notification">
            <span style="font-weight: 600; font-family: 'Poppins', sans-serif;">
                ✅ <%= messages[0] %>
            </span>
            <button class="toast-close" onclick="closeToast()">×</button>
        </div>
        
        <script>
            const toast = document.getElementById('toast-box');
            if (toast) {
                if (window.history.replaceState) {
                    const url = new URL(window.location);
                    url.searchParams.delete('msg');
                    window.history.replaceState(null, '', url);
                }

                setTimeout(() => {
                    closeToast();
                }, 3000);
            }

            function closeToast() {
                const t = document.getElementById('toast-box');
                if (t) {
                    t.classList.add('fade-out');
                    setTimeout(() => {
                        t.remove();
                    }, 500);
                }
            }
        </script>
    <% } %>

    <div class="crud-controls">
        <input type="text" id="searchInput" placeholder="Keresés névre..." onkeyup="filterTable()" class="search-input">
        
        <% if (user && user.role === 'admin') { %>
            <a href="/crud/add" class="add-new-btn">Új énekes hozzáadása</a>
        <% } %>
    </div>

    <% if (enekesek.length > 0) { %>
        <table id="enekesTable">
            <thead>
                <tr>
                    <th>Név</th>
                    <th>Születési év</th>
                    <% if (user && user.role === 'admin') { %>
                        <th style="text-align: right;">Műveletek</th>
                    <% } %>
                </tr>
            </thead>
            <tbody>
                <% enekesek.forEach(enekes => { %>
                    <tr>
                        <td class="enekes-nev" style="font-weight: 600; color: #fff;"><%= enekes.nev %></td>
                        <td><%= enekes.szulev %></td>
                        
                        <% if (user && user.role === 'admin') { %>
                            <td style="text-align: right;">
                                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                                    <a href="/crud/edit/<%= enekes._id %>" class="action-button">Szerkesztés</a>
                                    
                                    <form method="POST" action="/crud/delete/<%= enekes._id %>" style="margin:0; padding:0; background:transparent; box-shadow:none;">
                                        <button type="submit" class="action-button" onclick="return confirm('Biztosan törölni szeretnéd ezt az énekest?')">Törlés</button>
                                    </form>
                                </div>
                            </td>
                        <% } %>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    <% } else { %>
        <p style="text-align: center; color: #888; margin-top: 30px;">Jelenleg nincs énekes az adatbázisban.</p>
    <% } %>

</div>

<script>
function filterTable() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toUpperCase();
    const table = document.getElementById('enekesTable');
    if (!table) return;
    const tr = table.getElementsByTagName('tr');

    for (let i = 1; i < tr.length; i++) {
        const nameCell = tr[i].getElementsByClassName('enekes-nev')[0];
        if (nameCell) {
            const textValue = nameCell.textContent || nameCell.innerText;
            if (textValue.toUpperCase().indexOf(filter) > -1) {
                tr[i].style.display = '';
            } else {
                tr[i].style.display = 'none';
            }
        }       
    }
}
</script>